# 场景生成优化过程视频功能 - 快速上手

## 功能说明

这个新功能可以将场景生成的优化过程保存为视频，展示物体从随机噪声逐步优化到最终布局的完整过程。同时会保存每个时间步的物体详细信息（类别、位置、尺寸、旋转等）。

## 快速开始

### 1. 安装依赖（如果还没有安装）

```bash
pip install opencv-python
```

### 2. 运行测试

#### 无条件生成测试（推荐新手）
```bash
cd run
./generate_progressive_video_test.sh
```

#### 文本条件生成测试
```bash
cd run
./generate_progressive_video_text_test.sh
```

### 3. 查看结果

测试完成后，在以下位置查看输出：

```bash
# 卧室场景示例
cd ../pretrained/bedrooms_uncond/test_progressive_video/progressive_video/

# 查看生成的视频
ls videos/          # *.mp4 文件

# 查看渲染帧
ls frames/          # *.png 文件

# 查看物体信息
cat object_info/xxx_scene000_step0000.json
```

## 输出文件说明

```
progressive_video/
├── videos/              # MP4视频文件（最终成果）
├── frames/              # 每个时间步的PNG图像
└── object_info/         # 每个时间步的物体信息JSON
```

### JSON文件示例

```json
{
  "num_objects": 5,
  "objects": [
    {
      "object_id": 0,
      "class_label": "bed",          // 物体类别
      "translation": {               // 位置 (x, y, z)
        "x": 0.123, "y": 0.0, "z": -0.456
      },
      "size": {                      // 尺寸 (长, 高, 宽)
        "x": 1.8, "y": 0.5, "z": 2.0
      },
      "rotation_angle": 1.57,        // 旋转角度（弧度）
      "model_jid": "abc123"          // 3D模型ID
    }
  ]
}
```

## 在现有脚本中使用

在任何现有的生成脚本（如 `generate.sh`）中添加三个参数即可：

```bash
xvfb-run -a python generate_diffusion.py $config $output_dir $threed_future \
    --weight_file $weight_file \
    --without_screen \
    --n_sequences 10 \
    ... \
    --save_progressive_video \        # 启用视频功能
    --video_num_steps 10 \            # 采样10个中间步骤
    --video_fps 5                     # 5帧每秒
```

## 参数调整

| 参数 | 说明 | 推荐值 | 效果 |
|------|------|--------|------|
| `--video_num_steps` | 采样的中间步骤数 | 8-12 | 越大视频越长越详细，但生成越慢 |
| `--video_fps` | 视频帧率 | 5-8 | 越大播放越快 |

## 常见问题

**Q: 视频生成失败？**
A: 安装依赖：`pip install opencv-python`

**Q: 生成速度太慢？**
A: 减少 `--video_num_steps`（如改为 5）和 `--n_sequences`（如改为 3）

**Q: 内存不足？**
A: 同样减少步骤数和序列数

**Q: 想要更快的播放速度？**
A: 增大 `--video_fps`（如改为 10）

## 完整文档

详细说明请查看：[PROGRESSIVE_VIDEO_GUIDE.md](PROGRESSIVE_VIDEO_GUIDE.md)

## 示例命令

```bash
# 最小测试（3个场景，5个步骤）
cd scripts
xvfb-run -a python generate_diffusion.py \
    ../config/uncond/diffusion_bedrooms_instancond_lat32_v.yaml \
    ../output/quick_test \
    ../3d_front_processed/threed_future_model_bedroom.pkl \
    --weight_file ../pretrained_diffusion/bedrooms_uncond/model_30000 \
    --without_screen --n_sequences 3 --render_top2down --no_texture \
    --without_floor --clip_denoised --retrive_objfeats \
    --save_progressive_video --video_num_steps 5 --video_fps 5 \
    --path_to_3d_future_models_dir ../dataset/3D-FUTURE-model
```
